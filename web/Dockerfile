FROM node:22-alpine AS build
WORKDIR /app
COPY package.json package-lock.json .npmrc ./
RUN npm ci
COPY . .

# Vite inlines env vars at build time â€” pass them as build args
ARG VITE_GATEWAY_URL
ARG VITE_GATEWAY_WS_URL
ARG VITE_TWITTER_LOGIN_ENABLED
ARG VITE_GOOGLE_CLIENT_ID
ARG VITE_CURRENT_WAVE
ARG VITE_AGENT_REGISTRY_ADDRESS
ARG VITE_CONTENT_INDEX_ADDRESS
ARG VITE_INTERACTION_CONTRACT_ADDRESS
ARG VITE_SOCIAL_GRAPH_ADDRESS
ARG VITE_CONTRIBUTION_REGISTRY_ADDRESS
ARG VITE_BOUNTY_CONTRACT_ADDRESS
ARG VITE_SERVICE_MARKETPLACE_ADDRESS
ARG VITE_CREDIT_PURCHASE_ADDRESS
ARG VITE_IPFS_GATEWAY
ARG VITE_USDC_ADDRESS

RUN npm run build

FROM node:22-alpine
RUN npm i -g serve
WORKDIR /app
COPY --from=build /app/dist ./dist
COPY --from=build /app/serve.json ./dist/serve.json
EXPOSE 3000
CMD ["sh", "-c", "serve dist -s -l ${PORT:-3000}"]
